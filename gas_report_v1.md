# NFTMarket 合约 Gas Report v1

## 测试概览

- **测试文件**: `test/NFTMarket.t.sol`
- **测试用例数量**: 20 个测试用例
- **测试结果**: 全部通过 (20 passed, 0 failed, 0 skipped)
- **测试时间**: 156.22ms

## 合约部署成本

### NFTMarket 合约
- **部署成本**: 3,159,159 gas
- **部署大小**: 14,704 bytes

### SimpleNFT 合约
- **部署成本**: 1,949,216 gas
- **部署大小**: 9,758 bytes

### TestToken 合约
- **部署成本**: 1,246,269 gas
- **部署大小**: 6,981 bytes

## NFTMarket 合约函数 Gas 消耗详情

### 核心交易函数

#### 1. `list` - NFT 上架函数
- **最小消耗**: 30,515 gas
- **平均消耗**: 316,194 gas
- **中位数**: 325,728 gas
- **最大消耗**: 325,752 gas
- **调用次数**: 287 次
- **说明**: 这是最消耗 gas 的函数，因为需要转移 NFT 到市场合约

#### 2. `buyNFT` - NFT 购买函数
- **最小消耗**: 32,186 gas
- **平均消耗**: 96,831 gas
- **中位数**: 98,441 gas
- **最大消耗**: 103,241 gas
- **调用次数**: 276 次
- **说明**: 涉及代币转移和 NFT 转移，gas 消耗较高

#### 3. `delist` - NFT 下架函数
- **消耗**: 49,634 gas (固定)
- **调用次数**: 1 次
- **说明**: 将 NFT 从市场转移回卖家

### 管理函数

#### 4. `addSupportedToken` - 添加支持代币
- **消耗**: 46,545 gas (固定)
- **调用次数**: 60 次
- **说明**: 只有 owner 可以调用

#### 5. `updatePrice` - 更新价格
- **消耗**: 45,348 gas (固定)
- **调用次数**: 1 次
- **说明**: 更新已上架 NFT 的价格和支付代币

#### 6. `pause` - 暂停合约
- **消耗**: 28,133 gas (固定)
- **调用次数**: 1 次

#### 7. `unpause` - 恢复合约
- **消耗**: 28,196 gas (固定)
- **调用次数**: 1 次

### 查询函数

#### 8. `getListing` - 获取上架信息
- **消耗**: 17,172 gas (固定)
- **调用次数**: 260 次
- **说明**: 读取存储数据，消耗相对较低

#### 9. `getListedCount` - 获取上架数量
- **消耗**: 2,528 gas (固定)
- **调用次数**: 1 次

#### 10. `paused` - 查询暂停状态
- **消耗**: 2,496 gas (固定)
- **调用次数**: 2 次

## SimpleNFT 合约函数 Gas 消耗

### 核心函数

#### 1. `mint` - 铸造 NFT
- **最小消耗**: 59,528 gas
- **平均消耗**: 69,299 gas
- **中位数**: 59,528 gas
- **最大消耗**: 93,728 gas
- **调用次数**: 70 次

#### 2. `setApprovalForAll` - 设置授权
- **最小消耗**: 24,806 gas
- **平均消耗**: 45,674 gas
- **中位数**: 46,718 gas
- **最大消耗**: 46,718 gas
- **调用次数**: 21 次

### 查询函数

#### 3. `ownerOf` - 查询所有者
- **消耗**: 3,071 gas (固定)
- **调用次数**: 541 次

#### 4. `isApprovedForAll` - 查询授权状态
- **消耗**: 3,264 gas (固定)
- **调用次数**: 280 次

#### 5. `getApproved` - 查询单个授权
- **消耗**: 3,308 gas (固定)
- **调用次数**: 1 次

#### 6. `getCurrentTokenId` - 查询当前 Token ID
- **消耗**: 2,499 gas (固定)
- **调用次数**: 10 次

## TestToken 合约函数 Gas 消耗

### 核心函数

#### 1. `mint` - 铸造代币
- **最小消耗**: 53,969 gas
- **平均消耗**: 56,261 gas
- **中位数**: 54,209 gas
- **最大消耗**: 71,285 gas
- **调用次数**: 496 次

#### 2. `approve` - 授权代币
- **最小消耗**: 25,001 gas
- **平均消耗**: 47,234 gas
- **中位数**: 47,285 gas
- **最大消耗**: 47,285 gas
- **调用次数**: 437 次

### 查询函数

#### 3. `balanceOf` - 查询余额
- **消耗**: 2,851 gas (固定)
- **调用次数**: 290 次

#### 4. `allowance` - 查询授权额度
- **消耗**: 3,201 gas (固定)
- **调用次数**: 272 次

## Gas 消耗分析

### 高消耗函数排名
1. **`list`** - 316,194 gas (平均) - NFT 上架
2. **`buyNFT`** - 96,831 gas (平均) - NFT 购买
3. **`delist`** - 49,634 gas - NFT 下架
4. **`addSupportedToken`** - 46,545 gas - 添加支持代币
5. **`updatePrice`** - 45,348 gas - 更新价格

### 低消耗函数
- **查询函数**: 2,496 - 17,172 gas
- **管理函数**: 28,133 - 28,196 gas

### 优化建议

1. **批量操作**: 考虑添加批量上架/下架功能
2. **事件优化**: 减少不必要的事件参数
3. **存储优化**: 考虑使用更紧凑的数据结构
4. **权限检查**: 优化重复的权限验证逻辑

## 测试用例 Gas 消耗

### 成功场景测试
- `test_ListNFT_Success`: 396,756 gas
- `test_BuyNFT_Success`: 525,946 gas
- `test_DelistNFT`: 419,311 gas
- `test_UpdatePrice`: 413,371 gas

### 错误场景测试
- `test_ListNFT_NotOwner`: 55,292 gas
- `test_ListNFT_ZeroPrice`: 49,127 gas
- `test_BuyNFT_NotListed`: 45,720 gas
- `test_BuyNFT_InsufficientBalance`: 387,210 gas

### 模糊测试
- `test_Fuzz_ListAndBuyNFT`: 570,493 gas (平均，256 次运行)

### 不变性测试
- `test_Invariant_NoTokenBalance`: 1,202,668 gas
- `test_Invariant_NoTokenBalance_AfterMultipleTransactions`: 4,608,267 gas

## 总结

NFTMarket 合约的 gas 消耗主要集中在 NFT 的转移操作上，特别是 `list` 和 `buyNFT` 函数。这些函数涉及多个外部调用（ERC721 和 ERC20 合约），因此 gas 消耗较高。查询函数和管理函数的 gas 消耗相对较低，符合预期。

合约的整体设计在 gas 效率方面是合理的，主要的 gas 消耗都来自于必要的区块链操作（NFT 转移、代币转移等）。 